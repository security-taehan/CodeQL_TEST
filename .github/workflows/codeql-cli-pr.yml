name: "CodeQL CLI PR Scan"

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  codeql-cli:
    runs-on: ubuntu-latest

    permissions:
      contents: read           # ì½”ë“œ ì½ê¸°
      pull-requests: write     # PR ëŒ“ê¸€ ì‘ì„±
      security-events: write   # SARIF ì—…ë¡œë“œ (public repoì—ì„œëŠ” ê¸°ë³¸ í—ˆìš©)

    steps:
      # 1ï¸âƒ£ Checkout
      - name: Checkout repository
        uses: actions/checkout@v5

      # 2ï¸âƒ£ Install CodeQL CLI
      - name: Install CodeQL CLI
        run: |
          curl -L -o codeql.zip https://github.com/github/codeql-cli-binaries/releases/latest/download/codeql-linux64.zip
          unzip -q codeql.zip
          echo "$PWD/codeql" >> $GITHUB_PATH
          rm codeql.zip

      # 3ï¸âƒ£ Create CodeQL database
      - name: Create CodeQL database
        run: |
          codeql database create codeql-db \
            --language=javascript \
            --source-root=.

      # 4ï¸âƒ£ Run CodeQL analysis (official queries, auto-download)
      - name: Run CodeQL analysis
        env:
          JAVA_TOOL_OPTIONS: "-Xmx4g"  # Java heap 4GBë¡œ ì¦ê°€
        run: |
          codeql database analyze codeql-db \
            codeql/javascript-queries:codeql-suites/javascript-security-and-quality.qls \
            --download \
            --format=sarifv2.1.0 \
            --output=codeql-results.sarif

      # 5ï¸âƒ£ Upload SARIF
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: codeql-results.sarif
          category: codeql-cli-pr
      
      # 5ï¸âƒ£-1 Upload SARIF as Artifact (ë‹¤ìš´ë¡œë“œìš©)
      - name: Upload SARIF artifact
        uses: actions/upload-artifact@v4
        with:
          name: codeql-results-sarif
          path: codeql-results.sarif
          retention-days: 7

      # 6ï¸âƒ£ Post PR comment
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            const body =
              "ğŸ” **CodeQL ë¶„ì„ ì™„ë£Œ**\n\n" +
              "- ë¶„ì„ ë°©ì‹: CodeQL CLI (ë¬´ë£Œ)\n" +
              "- ê²°ê³¼ ìœ„ì¹˜: **Security â†’ Code scanning**\n" +
              "- ë¶„ì„ ë²”ìœ„: ì €ì¥ì†Œ ì „ì²´ ì½”ë“œ ê¸°ì¤€\n\n" +
              "ğŸ‘‰ ìƒì„¸ ì·¨ì•½ì ì€ Security íƒ­ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.";

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
